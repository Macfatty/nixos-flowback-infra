# deploy/forgejo-compose.yml
services:
  # --- INFRASTRUCTURE: PostgreSQL for Forgejo ---
  forgejo-db:
    image: postgres:16.2
    container_name: forgejo-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${FORGEJO_DB}
      POSTGRES_USER: ${FORGEJO_DB_USER}
      POSTGRES_PASSWORD: ${FORGEJO_DB_PASSWORD}
    volumes:
      # Persistent storage on the host
      - /persist/compose/forgejo/data/postgres:/var/lib/postgresql/data
    healthcheck:
      # Ensure DB is ready before starting Forgejo
      test: ["CMD-SHELL", "pg_isready -U ${FORGEJO_DB_USER} -d ${FORGEJO_DB}"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - flowback-shared-net

  # --- INFRASTRUCTURE: Forgejo Git Server ---
  forgejo:
    image: codeberg.org/forgejo/forgejo:9
    container_name: forgejo
    restart: unless-stopped
    depends_on:
      forgejo-db:
        condition: service_healthy
    environment:
      USER_UID: "1000"
      USER_GID: "100"
      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: forgejo-db:5432
      FORGEJO__database__NAME: ${FORGEJO_DB}
      FORGEJO__database__USER: ${FORGEJO_DB_USER}
      FORGEJO__database__PASSWD: ${FORGEJO_DB_PASSWORD}
      FORGEJO__server__ROOT_URL: http://git.local/
      FORGEJO__server__HTTP_PORT: "3000"
      FORGEJO__server__SSH_PORT: "${FORGEJO_SSH_PORT:-2222}"
      FORGEJO__server__DOMAIN: git.local
      FORGEJO__server__DISABLE_SSH: "false"
      FORGEJO__actions__ENABLED: "true"
    volumes:
      - /persist/compose/forgejo/data/forgejo:/data
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "${FORGEJO_HTTP_PORT:-3001}:3000"
      - "${FORGEJO_SSH_PORT:-2222}:22"
    networks:
      - flowback-shared-net

networks:
  flowback-shared-net:
    external: true
